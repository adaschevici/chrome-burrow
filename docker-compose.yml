name: chrome-cdp

x-chrome-common: &chrome-common
  image: chrome-cdp:${DISTRO:-debian}-${MODE:-headless}-stealth-${STEALTH:-basic}
  container_name: chrome-${DISTRO:-debian}-${MODE:-headless}-stealth-${STEALTH:-basic}
  networks: [cdpnet]
  shm_size: "${HEADLESS_SHM_SIZE}"
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-fsS", "http://0.0.0.0:${SOCAT_PORT}/json/version"]
    interval: 10s
    timeout: 3s
    retries: 5
    start_period: 15s

services:
  chrome-headless:
    <<: *chrome-common
    build:
      context: ./headless
      dockerfile: Dockerfile.${DISTRO:-debian}
      args:
        STEALTH: ${STEALTH:-basic}
    ports:
      - "${CDP_HOST_PORT}:${SOCAT_PORT}"

  chrome-gui:
    <<: *chrome-common
    build:
      context: ./gui
      dockerfile: Dockerfile.${DISTRO:-debian}
      args:
        STEALTH: ${STEALTH:-basic}
    ports:
      - "${CDP_HOST_PORT}:${SOCAT_PORT}"
      - "${VNC_PORT}:5900"
      - "${NOVNC_PORT}:6080"

networks:
  cdpnet:
    driver: bridge
